

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Workflow Implementations in Python &mdash; miaaim 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Jupyter Notebook Zoo" href="jupyter.html" />
    <link rel="prev" title="Installation" href="python.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: 5DADE2" >
          

          
            <a href="index.html" class="icon icon-home"> miaaim
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Nextflow User Guide / Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="installation.html#linux-os-x">Linux / OS X</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#windows">Windows</a></li>
<li class="toctree-l2"><a class="reference internal" href="installation.html#installing-miaaim-in-python">Installing MIAAIM in Python</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quick_start.html#prototype-001">prototype-001</a><ul>
<li class="toctree-l3"><a class="reference internal" href="quick_start.html#download-data">Download Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="quick_start.html#image-preprocessing">Image Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="quick_start.html#image-registration">Image Registration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="directory.html">Folder Structure</a><ul>
<li class="toctree-l2"><a class="reference internal" href="directory.html#input">input</a></li>
<li class="toctree-l2"><a class="reference internal" href="directory.html#hdiprep">hdiprep</a></li>
<li class="toctree-l2"><a class="reference internal" href="directory.html#hdireg">hdireg</a></li>
<li class="toctree-l2"><a class="reference internal" href="directory.html#docs">docs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="workflows.html">Workflows</a><ul>
<li class="toctree-l2"><a class="reference internal" href="workflows.html#image-preparation-hdiprep">Image Preparation (HDIprep)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="workflows.html#yaml-parameter-file-input-basics">YAML Parameter File Input Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="workflows.html#high-parameter-image-processing">High-Parameter Image Processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="workflows.html#histological-image-processing">Histological Image Processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="workflows.html#hdiprep-implementation-guide">HDIprep Implementation Guide</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="workflows.html#image-registration-hdireg">Image Registration (HDIreg)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="workflows.html#hdireg-implementation-guide">HDIreg Implementation Guide</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="workflows.html#tissue-state-modelling-patchmap">Tissue State Modelling (PatchMAP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="workflows.html#cross-system-tissue-information-transfer-i-patchmap">Cross-System/Tissue Information Transfer (i-PatchMAP)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="parameters.html">Parameter Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#nextflow">Nextflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#hdiprep">HDIprep</a></li>
<li class="toctree-l2"><a class="reference internal" href="parameters.html#hdireg">HDIreg</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#docker-singularity-containers">Docker/Singularity Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#resource-allocation">Resource Allocation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#memory">Memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html#cpu">CPU</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html#preset-resource-allocation-options">Preset Resource Allocation Options</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="provenance.html">Provenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#adding-imaging-modalities">Adding Imaging Modalities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#importing-new-modalities-adding-file-formats">Importing New Modalities / Adding File Formats</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">MIAAIM in Python</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="python.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="python.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="python.html#usage-without-docker-install-with-pip">Usage without Docker / Install with Pip</a></li>
<li class="toctree-l2"><a class="reference internal" href="python.html#reproducibility-with-pip">Reproducibility with Pip</a></li>
<li class="toctree-l2"><a class="reference internal" href="python.html#docker">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="python.html#hdi-utility-functions-hdi-utils">HDI Utility Functions (hdi-utils)</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Workflow Implementations in Python</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#image-preparation-hdiprep">Image Preparation (HDIprep)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#steady-state-umap-compression">Steady-state UMAP compression</a></li>
<li class="toctree-l3"><a class="reference internal" href="#histological-image-processing">Histological Image Processing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#image-registration-hdireg">Image Registration (HDIreg)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#elastix">elastix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transformix">transformix</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tissue-state-modeling-patchmap">Tissue State Modeling (PatchMAP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cross-system-tissue-information-transfer-i-patchmap">Cross-System/Tissue Information Transfer (i-PatchMAP)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="jupyter.html">Jupyter Notebook Zoo</a><ul>
<li class="toctree-l2"><a class="reference internal" href="jupyter.html#image-preparation-hdiprep">Image Preparation (HDIprep)</a></li>
<li class="toctree-l2"><a class="reference internal" href="jupyter.html#image-registration-hdireg">Image Registration (HDIreg)</a></li>
<li class="toctree-l2"><a class="reference internal" href="jupyter.html#id1">Image Registration (HDIreg)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#image-preparation-hdiprep">Image Preparation (HDIprep)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api.html#module-hdiprep.HDIprep.hdi_prep">hdi_prep</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#module-hdiprep.HDIprep.utils">utils</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api.html#image-registration-hdireg">Image Registration (HDIreg)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="api.html#module-hdireg.HDIreg.elastix">elastix</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#module-hdireg.HDIreg.transformix">transformix</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html#id7">utils</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="api.html#tissue-state-modeling-patchmap">Tissue State Modeling (PatchMAP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#cross-system-tissue-information-transfer-i-patchmap">Cross-System/Tissue Information Transfer (i-PatchMAP)</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Background on MIAAIM</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="background.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="elastix.html">Elastix Basics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="elastix.html#registration-parameter-files-elastix">Registration Parameter Files (Elastix)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="elastix.html#multi-channel-input">Multi-channel Input</a></li>
<li class="toctree-l3"><a class="reference internal" href="elastix.html#single-channel-input">Single-channel Input</a></li>
<li class="toctree-l3"><a class="reference internal" href="elastix.html#help-the-registration-with-manual-landmarks">Help the Registration with Manual Landmarks</a></li>
<li class="toctree-l3"><a class="reference internal" href="elastix.html#outputs">Outputs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="elastix.html#applying-transformations-transformix">Applying Transformations (Transformix)</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Roadmap</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">MIAAIM Roadmap</a><ul>
<li class="toctree-l2"><a class="reference internal" href="roadmap.html#miaaim-0-0-1">MIAAIM 0.0.1</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contributing.html#adding-imaging-modalities">Adding Imaging Modalities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contributing.html#importing-new-modalities-adding-file-formats">Importing New Modalities / Adding File Formats</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">FAQs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faqs.html">FAQs</a></li>
</ul>
<p class="caption"><span class="caption-text">Contact</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Contact Information</a></li>
</ul>
<p class="caption"><span class="caption-text">Funding</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="funding.html">Funding</a></li>
</ul>
<p class="caption"><span class="caption-text">License</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
</ul>
<p class="caption"><span class="caption-text">Acknowledgements</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">miaaim</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Workflow Implementations in Python</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/JoshuaHess12/miaaim/blob/0.0.1python-workflows.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="workflow-implementations-in-python">
<span id="pworkflows-to-pworkflows"></span><h1>Workflow Implementations in Python<a class="headerlink" href="#workflow-implementations-in-python" title="Permalink to this headline">¶</a></h1>
<p>MIAAIM’s workflows can also be run in Python to allow for more user flexibility with
custom workflow creation. To install <a class="reference external" href="https://github.com/JoshuaHess12/miaaim-python">MIAAIM in Python</a>, follow these steps:</p>
<div class="section" id="image-preparation-hdiprep">
<h2>Image Preparation (HDIprep)<a class="headerlink" href="#image-preparation-hdiprep" title="Permalink to this headline">¶</a></h2>
<p>The HDIprep workflow can be used in Python, just as it can be used in the
command line interface. Commands are sequentially applied to images and
are specified by the user.</p>
<div class="section" id="steady-state-umap-compression">
<h3>Steady-state UMAP compression<a class="headerlink" href="#steady-state-umap-compression" title="Permalink to this headline">¶</a></h3>
<p>Here, we will run through an example of using the HDIprep workflow in MIAAIM
to create steady-state UMAP embeddings of a high-dimensional image data set. We
will be using the mass spectrometry imaging data from <code class="code docutils literal notranslate"><span class="pre">prototype-001</span></code>:</p>
<ol class="arabic simple">
<li><p>First import the necessary modules. We will also define a helper function
to create plots after UMAP embedding.</p></li>
</ol>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import hdi utils module</span>
<span class="kn">import</span> <span class="nn">hdiutils.HDIimport.hdi_reader</span> <span class="k">as</span> <span class="nn">hdi_reader</span>
<span class="c1"># import hdi_prep module</span>
<span class="kn">from</span> <span class="nn">miaaim.hdiprep.HDIprep</span> <span class="kn">import</span> <span class="n">hdi_prep</span>
<span class="c1"># import external modules</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">minmax_scale</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>

<span class="c1"># create function for easy plotting</span>
<span class="k">def</span> <span class="nf">plot_rgb_2D</span><span class="p">(</span>
                <span class="n">embedding</span><span class="p">,</span>
                <span class="n">axs</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">cols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">out_name</span><span class="o">=</span><span class="kc">None</span>
                <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    helper function for plotting 2D scatter plots from dimension reduction method.</span>

<span class="sd">    axs: tuple of 2 integers indicating which axes to extract for plotting</span>
<span class="sd">    cols: tuple of 3 integers indicating which axes to use for RGB coloring</span>
<span class="sd">    out_name: name to export image as (if None, then no image exported)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># create rgb scale based off first 3 channel</span>
    <span class="n">rgb</span><span class="o">=</span><span class="n">minmax_scale</span><span class="p">(</span><span class="n">embedding</span><span class="p">[:,</span><span class="n">cols</span><span class="p">])</span>
    <span class="c1"># extract the columns to plot</span>
    <span class="n">to_plot</span><span class="o">=</span><span class="n">embedding</span><span class="p">[:,</span> <span class="n">axs</span><span class="p">]</span>

    <span class="c1"># create manual legend items for plotting purposes</span>
    <span class="n">red_patch</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;UMAP 1&#39;</span><span class="p">)</span>
    <span class="n">green_patch</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;UMAP 2&#39;</span><span class="p">)</span>
    <span class="n">blue_patch</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;UMAP 3&#39;</span><span class="p">)</span>

    <span class="c1"># scatter plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">to_plot</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">to_plot</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">rgb</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Steady State UMAP Embedding&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;UMAP </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;UMAP </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">red_patch</span><span class="p">,</span><span class="n">green_patch</span><span class="p">,</span><span class="n">blue_patch</span><span class="p">],</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Linear Scale&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_name</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span><span class="n">pad_inches</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>2. Next, we will import the data and run the steady-state UMAP embedding on the
prototype dataset.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># read data with HDIutils</span>
<span class="n">mov_im</span> <span class="o">=</span> <span class="n">hdi_reader</span><span class="o">.</span><span class="n">HDIreader</span><span class="p">(</span>
                    <span class="n">path_to_data</span><span class="o">=</span><span class="n">path_to_im</span><span class="p">,</span>
                    <span class="n">path_to_markers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">subsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">save_mem</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
<span class="c1"># create data set using HDIprep module</span>
<span class="n">mov_dat</span> <span class="o">=</span> <span class="n">hdi_prep</span><span class="o">.</span><span class="n">IntraModalityDataset</span><span class="p">([</span><span class="n">mov_im</span><span class="p">])</span>
<span class="c1"># apply steady state UMAP embedding</span>
<span class="n">mov_dat</span><span class="o">.</span><span class="n">RunOptimalUMAP</span><span class="p">(</span>
                        <span class="n">dim_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">),</span>
                        <span class="n">landmarks</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span>
                        <span class="n">export_diagnostics</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">output_dir</span><span class="o">=</span><span class="n">out_path</span><span class="p">,</span>
                        <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span>
</pre></div>
</div>
<p>Since we chose to export diagnostic plots using <code class="code docutils literal notranslate"><span class="pre">export_diagnostics=True</span></code>,
we obtained a resulting image of the exponential fit to the fuzzy set cross entropy
that was used to compute the steady-state UMAP embedding:</p>
<img alt="_images/OptimalUMAP-prototype-001.jpeg" src="_images/OptimalUMAP-prototype-001.jpeg" />
<ol class="arabic simple" start="3">
<li><p>Now we can export a scatter plot of the 4-dimensional steady-state UMAP
embedding in Euclidean space. Here the colors are RGB values created from the
first 3 components of the embedding:</p></li>
</ol>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for plotting purposes, extract the key of the umap embedding</span>
<span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mov_dat</span><span class="o">.</span><span class="n">umap_embeddings</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># plot the embedding of the UMAP in Euclidean space</span>
<span class="n">embed</span> <span class="o">=</span> <span class="n">mov_dat</span><span class="o">.</span><span class="n">umap_embeddings</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="c1"># export a plot of the results in Euclidean space</span>
<span class="n">plot_rgb_2D</span><span class="p">(</span><span class="n">embed</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="s2">&quot;steady-state-UMAP-prototype-001.jpeg&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/steady-state-UMAP-prototype-001.jpeg" src="_images/steady-state-UMAP-prototype-001.jpeg" />
<ol class="arabic simple" start="4">
<li><p>A final step to process prototype-001 is to reconstruct the original raster
object using the coordinates of each pixel. Since the
image was not a rectangular array, we will map it back to the spatial domain
using the <code class="code docutils literal notranslate"><span class="pre">method=&quot;coordinate&quot;</span></code> option for the <code class="code docutils literal notranslate"><span class="pre">SpatiallyMapUMAP</span></code> function.</p></li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Running steady-state image processing on data that is stored an array
format follows the same process here, except the spatial mapping with
<code class="code docutils literal notranslate"><span class="pre">SpatiallyMapUMAP</span></code> uses the <code class="code docutils literal notranslate"><span class="pre">method=&quot;rectangular&quot;</span></code> option.</p>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reconstruct spatial image from UMAP embedding</span>
<span class="n">mov_dat</span><span class="o">.</span><span class="n">SpatiallyMapUMAP</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;coordinate&quot;</span><span class="p">)</span>
<span class="c1"># extract processed image</span>
<span class="n">proc_im</span> <span class="o">=</span> <span class="n">mov_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processed_image</span>
<span class="c1">#plot the image using matplotlib (only the first 3 channels using RGB scale)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">proc_im</span><span class="p">[:,:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)])</span>
</pre></div>
</div>
<img alt="_images/steady-state-UMAP-prototype-001-spatial.jpeg" src="_images/steady-state-UMAP-prototype-001-spatial.jpeg" />
<ol class="arabic simple" start="5">
<li><p>The last step is to export the image for subsequent registration to its H&amp;E
stained counterpart. Here we export the image with padding and image resizing
and view the results:</p></li>
</ol>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># export the processed image to the nifti format for image registration</span>
<span class="c1"># here we pad the image and resize it using bilinear interpolation for</span>
<span class="c1"># registration with the corresponding H&amp;E image.</span>
<span class="n">mov_dat</span><span class="o">.</span><span class="n">ExportNifti1</span><span class="p">(</span>
                    <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;/Users/joshuahess/Desktop/&quot;</span><span class="p">,</span>
                    <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;(20,20)&quot;</span><span class="p">,</span>
                    <span class="n">target_size</span><span class="o">=</span><span class="s2">&quot;(2472,1572)&quot;</span>
                    <span class="p">)</span>
<span class="c1"># load the exported image and view</span>
<span class="n">exported</span> <span class="o">=</span> <span class="n">hdi_reader</span><span class="o">.</span><span class="n">HDIreader</span><span class="p">(</span>
                    <span class="n">path_to_data</span><span class="o">=</span><span class="s2">&quot;/Users/joshuahess/Desktop/prostate_processed.nii&quot;</span><span class="p">,</span>
                    <span class="n">path_to_markers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">subsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">save_mem</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
<span class="c1"># plot the exported image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">exported</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">image</span><span class="p">[:,:,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)])</span>
</pre></div>
</div>
<img alt="_images/steady-state-UMAP-prototype-001-spatial-resize.jpeg" src="_images/steady-state-UMAP-prototype-001-spatial-resize.jpeg" />
</div>
<div class="section" id="histological-image-processing">
<h3>Histological Image Processing<a class="headerlink" href="#histological-image-processing" title="Permalink to this headline">¶</a></h3>
<p>Here we will demonstrate an example of running histology image processing on the
H&amp;E imaging modality. We will be using the prostate H&amp;E imaging data from
<code class="code docutils literal notranslate"><span class="pre">prototype-001</span></code> in the MIAAIM software.</p>
<ol class="arabic simple">
<li><p>First import the necessary modules.</p></li>
</ol>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import hdi utils module</span>
<span class="kn">import</span> <span class="nn">hdiutils.HDIimport.hdi_reader</span> <span class="k">as</span> <span class="nn">hdi_reader</span>
<span class="c1"># import hdi_prep module</span>
<span class="kn">from</span> <span class="nn">miaaim.hdiprep.HDIprep</span> <span class="kn">import</span> <span class="n">hdi_prep</span>
<span class="c1"># import external modules</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
<p>2. Now we will set the path to our imaging data and the output folders, and we will
read in the imaging data set using the <code class="code docutils literal notranslate"><span class="pre">HDIreader</span></code> class from the <code class="code docutils literal notranslate"><span class="pre">hdi-utils</span></code>
python package. We will then create a dataset using the <code class="code docutils literal notranslate"><span class="pre">HDIprep</span></code> module
imported above.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the path to the imaging data</span>
<span class="n">path_to_im</span> <span class="o">=</span> <span class="s2">&quot;/Users/joshuahess/Desktop/prototype-001/input/fixed&quot;</span>
<span class="c1"># set the path to the output directory</span>
<span class="n">out_path</span> <span class="o">=</span> <span class="s2">&quot;/Users/joshuahess/Desktop/prototype-001/notebook-output&quot;</span>

<span class="c1"># read data with HDIutils</span>
<span class="n">fix_im</span> <span class="o">=</span> <span class="n">hdi_reader</span><span class="o">.</span><span class="n">HDIreader</span><span class="p">(</span>
                 <span class="n">path_to_data</span><span class="o">=</span><span class="n">path_to_im</span><span class="p">,</span>
                 <span class="n">path_to_markers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">subsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">save_mem</span><span class="o">=</span><span class="kc">False</span>
                 <span class="p">)</span>
<span class="c1"># create data set using HDIprep module</span>
<span class="n">fix_dat</span> <span class="o">=</span> <span class="n">hdi_prep</span><span class="o">.</span><span class="n">IntraModalityDataset</span><span class="p">([</span><span class="n">fix_im</span><span class="p">])</span>
<span class="c1"># for plotting purposes, extract the key of the data set</span>
<span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>3. Now use the <code class="code docutils literal notranslate"><span class="pre">IntramodalityDataset</span></code> class to run sequential morphological
operations. Here we will show the input H&amp;E image along with the manually drawn
mask that we will use to help our image processing pipeline.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All data are stored in the <code class="code docutils literal notranslate"><span class="pre">IntramodalityDataset</span></code> as dictionary objects,
kept under their filename as the key.</p>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the histology image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-raw.jpeg" src="_images/histology-prototype-001-1-raw.jpeg" />
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the input manually drawn mask in ImageJ</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-mask.jpeg" src="_images/histology-prototype-001-1-mask.jpeg" />
<p>4. Next, we will convert the image to grayscale (carried out automatically in
the <code class="code docutils literal notranslate"><span class="pre">MedianFilter</span></code> function) and will use a median filter to remove salt and
pepper noise in the image prior to the thresholding process.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># apply sequential processing steps</span>
<span class="c1"># remove salt and pepper noise</span>
<span class="n">fix_dat</span><span class="o">.</span><span class="n">MedianFilter</span><span class="p">(</span><span class="n">filter_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># extract the procesed image to show</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processed_image</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-med1.jpeg" src="_images/histology-prototype-001-1-med1.jpeg" />
<p>5. After filtering, we will use the <code class="code docutils literal notranslate"><span class="pre">otsu</span></code> automatic thresholding method to convert
the grayscale image into a binary mask separating foreground from background.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create mask with thresholding</span>
<span class="n">fix_dat</span><span class="o">.</span><span class="n">Threshold</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;otsu&#39;</span><span class="p">)</span>
<span class="c1"># extract the procesed image to show</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processed_image</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>6. After thresholding, we will perform a series of morphological operations on the
mask to smooth edges, fill holes, and connect regions in the mask that should
represent the foreground (where the tissue is).</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># morphological opening</span>
<span class="n">fix_dat</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">disk_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># extract the procesed image to show</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processed_image</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-open1.jpeg" src="_images/histology-prototype-001-1-open1.jpeg" />
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># morphological closing</span>
<span class="n">fix_dat</span><span class="o">.</span><span class="n">Close</span><span class="p">(</span><span class="n">disk_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># extract the procesed image to show</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processed_image</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-close1.jpeg" src="_images/histology-prototype-001-1-close1.jpeg" />
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># morphological fill</span>
<span class="n">fix_dat</span><span class="o">.</span><span class="n">Fill</span><span class="p">()</span>
<span class="c1"># extract the procesed image to show</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processed_image</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-fill1.jpeg" src="_images/histology-prototype-001-1-fill1.jpeg" />
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># morphological opening</span>
<span class="n">fix_dat</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">disk_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># extract the processed image to show</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processed_image</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-open2.jpeg" src="_images/histology-prototype-001-1-open2.jpeg" />
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># apply the manual input mask (will act on the previous masks)</span>
<span class="n">fix_dat</span><span class="o">.</span><span class="n">ApplyManualMask</span><span class="p">()</span>
<span class="c1"># extract the processed image to show</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processed_image</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-manualmask.jpeg" src="_images/histology-prototype-001-1-manualmask.jpeg" />
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract bounding box in the image for constant padding</span>
<span class="n">fix_dat</span><span class="o">.</span><span class="n">NonzeroBox</span><span class="p">()</span>
<span class="c1"># extract the processed image to show</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processed_image</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-boxed.jpeg" src="_images/histology-prototype-001-1-boxed.jpeg" />
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># apply the final mask after all operations</span>
<span class="n">fix_dat</span><span class="o">.</span><span class="n">ApplyMask</span><span class="p">()</span>
<span class="c1"># extract the processed image to show</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processed_image</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-final.jpeg" src="_images/histology-prototype-001-1-final.jpeg" />
<p>7. We will now add padding to the edges of the image to register this image
to our mass spectrometry imaging data set. We recommend being a little generous
with how much padding you add – leaving too little room on the edges of your
image may make the registration optimization more difficult.</p>
<p>We will export the image with padding and read it back into our session to
view the results:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># export the processed image to the nifti format for image registration</span>
<span class="c1"># here we pad the image for registration with the corresponding MSI</span>
<span class="c1"># compressed image.</span>
<span class="n">fix_dat</span><span class="o">.</span><span class="n">ExportNifti1</span><span class="p">(</span>
                    <span class="n">output_dir</span><span class="o">=</span><span class="n">out_path</span><span class="p">,</span>
                    <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;(150,150)&quot;</span><span class="p">,</span>
                    <span class="n">target_size</span><span class="o">=</span><span class="kc">None</span>
                    <span class="p">)</span>

<span class="c1"># load the exported image and view</span>
<span class="n">exported</span> <span class="o">=</span> <span class="n">hdi_reader</span><span class="o">.</span><span class="n">HDIreader</span><span class="p">(</span>
                    <span class="n">path_to_data</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span><span class="s2">&quot;fixed_processed.nii&quot;</span><span class="p">),</span>
                    <span class="n">path_to_markers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">subsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">save_mem</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
<span class="c1"># plot the exported image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">exported</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-padded-final.jpeg" src="_images/histology-prototype-001-1-padded-final.jpeg" />
</div>
</div>
<div class="section" id="image-registration-hdireg">
<h2>Image Registration (HDIreg)<a class="headerlink" href="#image-registration-hdireg" title="Permalink to this headline">¶</a></h2>
<p>The HDIreg workflow in Python is split into two modules, just as it is in
Nextflow – the <code class="code docutils literal notranslate"><span class="pre">elastix</span></code> and <code class="code docutils literal notranslate"><span class="pre">transformix</span></code> workflows. Here, we will
show both of them on the same data – <code class="code docutils literal notranslate"><span class="pre">prototype-001</span></code>.</p>
<div class="section" id="elastix">
<h3>elastix<a class="headerlink" href="#elastix" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>First import the necessary modules.</p></li>
</ol>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import hdi utils module</span>
<span class="kn">import</span> <span class="nn">hdiutils.HDIimport.hdi_reader</span> <span class="k">as</span> <span class="nn">hdi_reader</span>
<span class="c1"># import elastix and transformix modules</span>
<span class="kn">from</span> <span class="nn">miaaim.hdiprep.HDIprep</span> <span class="kn">import</span> <span class="n">hdi_prep</span>
<span class="kn">from</span> <span class="nn">miaaim.hdireg.HDIreg</span> <span class="kn">import</span> <span class="n">elastix</span>
<span class="kn">from</span> <span class="nn">miaaim.hdireg.HDIreg</span> <span class="kn">import</span> <span class="n">transformix</span>
<span class="c1"># import external modules</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
<p>2. Now we will set the path to our processed imaging data and the output folder,
and we will read in the imaging data set using the <code class="code docutils literal notranslate"><span class="pre">HDIreader</span></code> class from
the <code class="code docutils literal notranslate"><span class="pre">hdi-utils</span></code> python package. We will then create a dataset using the
<code class="code docutils literal notranslate"><span class="pre">HDIprep</span></code> module imported above. We will set the path to both the fixed
image (the H&amp;E modality) and a moving image (the steady-state UMAP compressed image).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You do not need to import these modules to run <code class="code docutils literal notranslate"><span class="pre">elastix</span></code> and
<code class="code docutils literal notranslate"><span class="pre">transformix</span></code> from the <code class="code docutils literal notranslate"><span class="pre">hdi-reg</span></code> module. We are importing them
so that we can easily plot the results of the registration process.</p>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the path to the processed imaging data from hdiprep modules</span>
<span class="n">path_to_fixed</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\Josh_Hess\prototype-001\notebook-output\fixed_processed.nii&quot;</span>
<span class="n">path_to_moving</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\Josh_Hess\prototype-001\notebook-output\moving_processed.nii&quot;</span>
<span class="c1"># set the path to the output directory</span>
<span class="n">out_dir</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\Josh_Hess\prototype-001\notebook-output&quot;</span>

<span class="c1"># read data with HDIutils</span>
<span class="n">fix_im</span> <span class="o">=</span> <span class="n">hdi_reader</span><span class="o">.</span><span class="n">HDIreader</span><span class="p">(</span>
                    <span class="n">path_to_data</span><span class="o">=</span><span class="n">path_to_fixed</span><span class="p">,</span>
                    <span class="n">path_to_markers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">subsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">save_mem</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
<span class="c1"># create data set using HDIprep module</span>
<span class="n">fix_dat</span> <span class="o">=</span> <span class="n">hdi_prep</span><span class="o">.</span><span class="n">IntraModalityDataset</span><span class="p">([</span><span class="n">fix_im</span><span class="p">])</span>
<span class="c1"># for plotting purposes, extract the key of the data set</span>
<span class="n">fix_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># read data with HDIutils</span>
<span class="n">mov_im</span> <span class="o">=</span> <span class="n">hdi_reader</span><span class="o">.</span><span class="n">HDIreader</span><span class="p">(</span>
                    <span class="n">path_to_data</span><span class="o">=</span><span class="n">path_to_moving</span><span class="p">,</span>
                    <span class="n">path_to_markers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">subsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">save_mem</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
<span class="c1"># create data set using HDIprep module</span>
<span class="n">mov_dat</span> <span class="o">=</span> <span class="n">hdi_prep</span><span class="o">.</span><span class="n">IntraModalityDataset</span><span class="p">([</span><span class="n">mov_im</span><span class="p">])</span>
<span class="c1"># for plotting purposes, extract the key of the data set</span>
<span class="n">mov_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mov_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># plot the histology image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fix_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">fix_key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/histology-prototype-001-1-padded-final.jpeg" src="_images/histology-prototype-001-1-padded-final.jpeg" />
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the moving steady state UMAP compressed image (note that we are only showing</span>
<span class="c1"># the first three channels in RGB space)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mov_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">mov_key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">image</span><span class="p">[:,:,:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<img alt="_images/steady-state-UMAP-prototype-001-spatial-resize.jpeg" src="_images/steady-state-UMAP-prototype-001-spatial-resize.jpeg" />
<p>3. Next, we will register these two images using the <code class="code docutils literal notranslate"><span class="pre">HDIreg</span></code> workflow
and the manifold alignment scheme. We will do this by first registering the
images using an affine transformation, and then the images will be registered
nonlinearly. These are indicated in the input folder of <code class="code docutils literal notranslate"><span class="pre">prototype-001</span></code>
by the <code class="code docutils literal notranslate"><span class="pre">affine.txt</span></code> and <code class="code docutils literal notranslate"><span class="pre">nonlinear.txt</span></code> parameter files.</p>
<p>First, we set the paths to our parameter files and create a list from the two.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Elastix uses file paths as input rather than any objects from the <code class="code docutils literal notranslate"><span class="pre">HDIprep</span></code>
module.</p>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set path to affine registration parameters</span>
<span class="n">affine_pars</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\Josh_Hess\prototype-001\input\affine_short.txt&quot;</span>
<span class="c1"># set path to affine registration parameters</span>
<span class="n">nonlinear_pars</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\Josh_Hess\prototype-001\input\nonlinear_short.txt&quot;</span>
<span class="c1"># concatenate the two parameter files to a list</span>
<span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">affine_pars</span><span class="p">,</span> <span class="n">nonlinear_pars</span><span class="p">]</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Now we can register the images using the <code class="code docutils literal notranslate"><span class="pre">elastix</span></code> module.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are two pairs of elastix registration parameter files in the
<code class="code docutils literal notranslate"><span class="pre">input</span></code> folder for <code class="code docutils literal notranslate"><span class="pre">prototype-001</span></code>. Here we use the shorter
version for registration. The original version took ~1 hour to complete.
The short version took ~40min using this dataset. If you are not using a
machine with a lot of computing power, consider using the short version,
as shown here. The short version was created by changing the number of
resolutions and the number of spatial samples in the registration parameter files.</p>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the registration</span>
<span class="n">elastix</span><span class="o">.</span><span class="n">Elastix</span><span class="p">(</span><span class="n">path_to_fixed</span><span class="p">,</span>
                <span class="n">path_to_moving</span><span class="p">,</span>
                <span class="n">out_dir</span><span class="p">,</span>
                <span class="n">p</span><span class="p">,</span>
                <span class="n">fp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">fMask</span><span class="o">=</span><span class="kc">None</span>
                <span class="p">)</span>
</pre></div>
</div>
<p>In the nonlinear parameter file, <code class="code docutils literal notranslate"><span class="pre">nonlinear.txt</span></code>, we chose to export a r
esulting image from elastix after registration using the <code class="code docutils literal notranslate"><span class="pre">WriteResultImage</span></code>
option. The output of this registration will be labelled with the suffix <code class="code docutils literal notranslate"><span class="pre">.1</span></code>
since it is the second registration (the first registration would have
exported an image with the <code class="code docutils literal notranslate"><span class="pre">.0</span></code> suffix).</p>
<p>5. We can check the registration results by loading the images into ImageJ/FIJI.
Here we exported an overlay of one of the H&amp;E images and the resulting image from elastix.
We saved the file as <code class="code docutils literal notranslate"><span class="pre">elastix-fiji-stack.tif</span></code>. The cyan channel is the
H&amp;E modality, and the magenta channel is a channel from the MSI steady state compressed image.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Elastix will only export the first channel if you using the
<code class="code docutils literal notranslate"><span class="pre">WriteResultImage</span></code> option. The full image stack can be exported using
transformix, which we will show in a moment.</p>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set path to output image</span>
<span class="n">result_path</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\Josh_Hess\prototype-001\notebook-output\elastix-fiji-stack.tif&quot;</span>
<span class="c1"># read the output image stack for registration results</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">hdi_reader</span><span class="o">.</span><span class="n">HDIreader</span><span class="p">(</span>
                    <span class="n">path_to_data</span><span class="o">=</span><span class="n">result_path</span><span class="p">,</span>
                    <span class="n">path_to_markers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">flatten</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">subsample</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">save_mem</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
<span class="c1"># create data set using HDIprep module</span>
<span class="n">result_dat</span> <span class="o">=</span> <span class="n">hdi_prep</span><span class="o">.</span><span class="n">IntraModalityDataset</span><span class="p">([</span><span class="n">result</span><span class="p">])</span>
<span class="c1"># for plotting purposes, extract the key of the data set</span>
<span class="n">result_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># plot the histology image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">result_dat</span><span class="o">.</span><span class="n">set_dict</span><span class="p">[</span><span class="n">result_key</span><span class="p">]</span><span class="o">.</span><span class="n">hdi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/elastix-fiji-stack.jpg" src="_images/elastix-fiji-stack.jpg" />
</div>
<div class="section" id="transformix">
<h3>transformix<a class="headerlink" href="#transformix" title="Permalink to this headline">¶</a></h3>
<p>6. Now, we can transform the original moving image using the elastix registration
transform parameters. These are stored as <code class="code docutils literal notranslate"><span class="pre">TransformParameters.0.txt</span></code>
and <code class="code docutils literal notranslate"><span class="pre">TransformParameters.1.txt</span></code>, again numbered according to the
registration used (affine vs. nonlinear).</p>
<p>We set the path to the image registration parameters, the original moving image,
and we set the pad width and target image size that were used during the <code class="code docutils literal notranslate"><span class="pre">HDIprep</span></code>
module (see notebook 001). All padding and image resizing is carried out on a
per channel basis in <code class="code docutils literal notranslate"><span class="pre">Transformix</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that running transformix on prototype-001 took ~8min on this machine,
transformix 191 channels from the MSI data. The resulting file,
<code class="code docutils literal notranslate"><span class="pre">moving_result.nii</span></code>, is stored here as a <code class="code docutils literal notranslate"><span class="pre">.nii</span></code> stack, and is ~5.86 GB.</p>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set path to moving image</span>
<span class="n">in_im</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;D:\Josh_Hess\prototype-001\input\moving&quot;</span>
<span class="c1"># set path to output transform parameter files</span>
<span class="n">tps</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot;D:\Josh_Hess\prototype-001\notebook-output\TransformParameters.0.txt&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;D:\Josh_Hess\prototype-001\notebook-output\TransformParameters.1.txt&quot;</span><span class="p">]</span>
<span class="c1"># set target size and padding (see notebook 001 for details)</span>
<span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2472</span><span class="p">,</span><span class="mi">1572</span><span class="p">)</span>
<span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># transform the set of MSI data</span>
<span class="n">transformix</span><span class="o">.</span><span class="n">Transformix</span><span class="p">(</span><span class="n">in_im</span><span class="p">,</span>
                        <span class="n">out_dir</span><span class="p">,</span>
                        <span class="n">tps</span><span class="p">,</span>
                        <span class="n">target_size</span><span class="p">,</span>
                        <span class="n">pad</span><span class="p">,</span>
                        <span class="n">trim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">crops</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">out_ext</span> <span class="o">=</span> <span class="s2">&quot;.nii&quot;</span>
                        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="tissue-state-modeling-patchmap">
<h2>Tissue State Modeling (PatchMAP)<a class="headerlink" href="#tissue-state-modeling-patchmap" title="Permalink to this headline">¶</a></h2>
<p>Here, we will show how to stitch together data by demonstrating cobordism learning
in the PatchMAP workflow with the digits dataset.</p>
<ol class="arabic simple">
<li><p>First import the necessary modules.</p></li>
</ol>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># import patchmap module</span>
<span class="kn">from</span> <span class="nn">miaaim.patchmap</span> <span class="kn">import</span> <span class="n">patchmap_</span>
<span class="kn">from</span> <span class="nn">miaaim.patchmap</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="c1"># import external modules</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_digits</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
<p>2. Now we will we will read in the example data from the digits dataset.
We will then cut each individual digit into its own data frame to feed as input
to the   <code class="code docutils literal notranslate"><span class="pre">compute_cobordism</span></code> function of the <code class="code docutils literal notranslate"><span class="pre">patchmap</span></code> workflow.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load digits data</span>
<span class="n">digits</span> <span class="o">=</span> <span class="n">load_digits</span><span class="p">()</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">digits</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
<span class="c1"># Get the factor manifold IDs</span>
<span class="n">nms</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">digits</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
<span class="c1"># Create a combined data frame with names and data</span>
<span class="n">dat_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dat</span><span class="p">,</span><span class="n">nms</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Create a list to store all digits in</span>
<span class="n">digits_pd_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">digits_np_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Iterate through digits and create datafames for stitiching</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Hold out digit i</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">dat_pd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dat_pd</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># Update the pandas list</span>
    <span class="n">digits_pd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="c1"># Update the numpy list</span>
    <span class="n">digits_np_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="mi">64</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># Concatenate the lists</span>
<span class="n">pandas_digits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">digits_pd_list</span><span class="p">)</span>
<span class="n">np_digits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">digits_np_list</span><span class="p">)</span>
<span class="c1"># Create a colormap for the chosen labels</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">discrete_cmap</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pandas_digits</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="s1">&#39;tab20_r&#39;</span><span class="p">)</span>
<span class="c1"># Create colors</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pandas_digits</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]]</span>
</pre></div>
</div>
<p>3. Now use the <code class="code docutils literal notranslate"><span class="pre">compute_cobordism</span></code> function to create a higher-dimensional manifold
that models similarity between each of the digits in the dataset.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set number of nearest neighbors</span>
<span class="n">nn</span> <span class="o">=</span> <span class="mi">150</span>
<span class="c1"># run the simiplicial set patching</span>
<span class="n">patched_simplicial_set</span> <span class="o">=</span> <span class="n">patchmap_</span><span class="o">.</span><span class="n">compute_cobordism</span><span class="p">(</span>
                                    <span class="n">digits_np_list</span><span class="p">,</span>
                                    <span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">nn</span>
                                    <span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Now embed the cobordism into two-dimensional space for visualization.</p></li>
</ol>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># embed the data</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">patchmap_</span><span class="o">.</span><span class="n">embed_cobordism</span><span class="p">(</span>
                                <span class="n">digits_np_list</span><span class="p">,</span>
                                <span class="n">patched_simplicial_set</span><span class="p">,</span>
                                <span class="mi">2</span><span class="p">,</span>
                                <span class="n">n_epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                <span class="n">random_state</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                <span class="n">min_dist</span> <span class="o">=</span> <span class="mf">0.1</span>
                                <span class="p">)</span>

<span class="c1"># plot the results of embedded data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">])</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="n">linewidths</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/patchmap-digits-150nn.jpeg" src="_images/patchmap-digits-150nn.jpeg" />
</div>
<div class="section" id="cross-system-tissue-information-transfer-i-patchmap">
<h2>Cross-System/Tissue Information Transfer (i-PatchMAP)<a class="headerlink" href="#cross-system-tissue-information-transfer-i-patchmap" title="Permalink to this headline">¶</a></h2>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="jupyter.html" class="btn btn-neutral float-right" title="Jupyter Notebook Zoo" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="python.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Joshua Hess.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>